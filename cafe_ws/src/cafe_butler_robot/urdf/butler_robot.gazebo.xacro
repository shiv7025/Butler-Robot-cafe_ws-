<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro" name="butler_robot">

  <!-- Wheel friction parameters -->
  <xacro:macro name="wheel_gazebo_properties" params="link_name">
    <gazebo reference="${link_name}">
      <mu1>1000000.0</mu1>
      <mu2>1000000.0</mu2>
      <kp>1000000000.0</kp>
      <kd>10.0</kd>
      <minDepth>0.001</minDepth>
      <maxVel>0.1</maxVel>
      <fdir1>1 0 0</fdir1>
    </gazebo>
  </xacro:macro>

  <xacro:wheel_gazebo_properties link_name="wheel_left_link"/>
  <xacro:wheel_gazebo_properties link_name="wheel_right_link"/>

  <!-- Caster wheel parameters -->
  <xacro:macro name="caster_gazebo_properties" params="link_name">
    <gazebo reference="${link_name}">
      <mu1>0.1</mu1>
      <mu2>0.1</mu2>
      <kp>1000000.0</kp>
      <kd>100.0</kd>
      <minDepth>0.001</minDepth>
      <maxVel>1.0</maxVel>
    </gazebo>
  </xacro:macro>

  <xacro:caster_gazebo_properties link_name="caster_front_link"/>
  <xacro:caster_gazebo_properties link_name="caster_rear_link"/>

  <!-- ROS 2 Control Plugin -->
  <gazebo>
    <xacro:if value="$(arg is_ignition)">
      <plugin name="ign_ros2_control" filename="ign_ros2_control-system">
        <parameters>$(find cafe_butler_robot)/config/butler_controllers.yaml</parameters>
      </plugin>
      <plugin name="imu_plugin" filename="ignition-gazebo-imu-system" />
    </xacro:if>

    <xacro:unless value="$(arg is_ignition)">
      <plugin name="gz_ros2_control" filename="gz_ros2_control-system">
        <parameters>$(find cafe_butler_robot)/config/butler_controllers.yaml</parameters>
      </plugin>
      <plugin name="imu_plugin" filename="gz-sim-imu-system" />
    </xacro:unless>
  </gazebo>

  <!-- IMU Sensor -->
  <gazebo reference="imu_link">
    <sensor name="imu_sensor" type="imu">
      <always_on>true</always_on>
      <update_rate>100</update_rate>
      <topic>imu</topic>
      <imu>
        <angular_velocity>
          <x><noise type="gaussian"><mean>0.0</mean><stddev>2e-4</stddev></noise></x>
          <y><noise type="gaussian"><mean>0.0</mean><stddev>2e-4</stddev></noise></y>
          <z><noise type="gaussian"><mean>0.0</mean><stddev>2e-4</stddev></noise></z>
        </angular_velocity>
        <linear_acceleration>
          <x><noise type="gaussian"><mean>0.0</mean><stddev>1.7e-2</stddev></noise></x>
          <y><noise type="gaussian"><mean>0.0</mean><stddev>1.7e-2</stddev></noise></y>
          <z><noise type="gaussian"><mean>0.0</mean><stddev>1.7e-2</stddev></noise></z>
        </linear_acceleration>
      </imu>
    </sensor>
  </gazebo>

  <!-- LiDAR Sensor -->
  <gazebo reference="laser_link">
    <sensor name="lidar_sensor" type="lidar">
      <always_on>true</always_on>
      <visualize>true</visualize>
      <update_rate>10</update_rate>
      <topic>scan</topic>
      <lidar>
        <scan>
          <horizontal>
            <samples>360</samples>
            <resolution>1</resolution>
            <min_angle>-3.14</min_angle>
            <max_angle>3.14</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.1</min>
          <max>12.0</max>
          <resolution>0.01</resolution>
        </range>
      </lidar>
    </sensor>
  </gazebo>

  <!-- LiDAR Plugin -->
  <gazebo>
    <plugin name="lidar_plugin" filename="gz-sim-lidar-system"/>
  </gazebo>

</robot>
